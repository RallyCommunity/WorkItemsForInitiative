<!DOCTYPE html>
<html>
<head>
    <title>WorkItemsForInitiative</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.app.WorkItemsForIntiative.BurnCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var completedScheduleStateNames=this.getCompletedScheduleStateNames();return[{as:"Planned",f:function(snapshot){return snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"PlannedCompleted",f:function(snapshot){return _.contains(completedScheduleStateNames,snapshot.ScheduleState)&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}}]},getMetrics:function(){return[{field:"Planned",as:"Planned",display:"line",f:"sum"},{field:"PlannedCompleted",as:"Completed",f:"sum",display:"column"}]}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}},{xtype:"container",id:"piBurnupBox",border:1,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}}],piStr:"",objStr:"",portfolioIds:null,workItems:[],chsrDlg:null,lowestPiName:"",getSettingsFields:function(){var values=[{name:"epicIDs",xtype:"rallytextfield",label:" Space separated list of Portfolio Items",readOnly:!0},{name:"epicOBJs",xtype:"rallytextfield",hidden:!0}];return _.each(values,function(value){value.labelWidth=250,value.labelAlign="left"}),values},_findAllLowestLevelPIs:function(app){app.typeStore?_.each(app.typeStore.data.items,function(item){0===item.get("Ordinal")&&(app.lowestPiName=item.get("TypePath"))}):Rally.ui.notify.Notifier.show({message:"Portfolio Type Hierarchy not available. Try and reload page"});var objList=[],objAr=app.objStr.split(" ");_.each(objAr,function(str){objList.push(Number(str))});var piType=Ext.getCmp("typeSelector").rawValue,piStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,storeId:"piStore",fetch:["FormattedID","Name","Children","ScheduleState","PlanEstimate"],hydrate:["FormattedID","Name","ScheduleState"],filters:[{property:"_ItemHierarchy",operator:"$in",value:objList},{property:"_TypeHierarchy",value:app.lowestPiName},{property:"__At",value:"current"}],listeners:{load:function(store,data,success){app.portfolioIds=data,app._updateDetailsPanes(app)}}})},_doArtifactChooserDialog:function(app){app.chsrDlg&&app.chsrDlg.destroy(),artifactType="PortfolioItem",title="Choose ",Ext.getCmp("ignoreType").value===!1&&(artifactType+="/"+Ext.getCmp("typeSelector").rawValue,title+=Ext.getCmp("typeSelector").rawValue),app.chsrDlg=Ext.create("Rally.ui.dialog.SolrArtifactChooserDialog",{artifactTypes:artifactType,autoShow:!0,height:400,title:title+" item(s)",multiple:!0,storeConfig:{fetch:["UserStories","Name","FormattedID","TypePath","ObjectID","PortfolioItemType"],sorters:[{property:"PortfolioItemType",direction:"DESC"},{property:"FormattedID",direction:"ASC"}]},listeners:{artifactchosen:function(dialogBox,selectedRecord){var itmStr="",objStr="";selectedRecord.forEach(function(record){delim=""===itmStr?"":" ",itmStr+=delim+record.get("FormattedID"),objStr+=delim+(""+record.get("ObjectID"))}),app.updateSettingsValues({settings:{epicIDs:itmStr,epicOBJs:objStr}}),app.piStr=itmStr,app.objStr=objStr,app._updatePortfolioItemList(app),app._findAllLowestLevelPIs(app)}}})},_piBurnupChart:function(app){Ext.getCmp("piBurnupChart")&&Ext.getCmp("piBurnupChart").destroy();var rawChartData=[];_.each(app.portfolioIds,function(item){rawChartData.push(item.raw)});var objList=[],objAr=app.objStr.split(" ");_.each(objAr,function(str){objList.push(Number(str))}),Ext.getCmp("piBurnupBox").add({xtype:"rallychart",id:"piBurnupChart",calculatorType:"Rally.app.WorkItemsForIntiative.BurnCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted","Released"]},storeConfig:{find:{_TypeHierarchy:"HierarchichalRequirement",_ItemHierarchy:{$in:objList},Children:null},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"]},chartConfig:{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"PI Burnup"},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:5,title:{text:"Date",margin:10}},yAxis:[{title:{text:"Points"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},column:{stacking:null,shadow:!1}}}})},_piCustomGrid:function(app){Ext.getCmp("piGrid")&&Ext.getCmp("piGrid").destroy();var piGrid=Ext.create("Rally.ui.grid.Grid",{columnCfgs:["FormattedID","Name"],store:Ext.create("Rally.data.wsapi.Store",{model:app.lowestPiName,filters:[function(item){return!1}]}),id:"piGrid"});Ext.getCmp("piGridBox").add(piGrid)},_itemInList:function(item){},_updateDetailsPanes:function(app){app._piBurnupChart(app)},_updatePortfolioItemList:function(app){Ext.getCmp("selectionFromSettings")&&Ext.getCmp("selectionFromSettings").destroy();var txtMsg=Ext.create("Ext.form.field.Text",{fieldLabel:"Current Selected",id:"selectionFromSettings",grow:!0,value:app.piStr,border:0,margin:10,readOnly:!0});Ext.getCmp("headerBox").add(txtMsg)},typeStore:null,launch:function(){var app=this;ids=app.getSetting("epicIDs"),objs=app.getSetting("epicOBJs"),ids&&objs&&(app.piStr=ids,app.objStr=objs);var ignoreType=Ext.create("Rally.ui.CheckboxField",{fieldLabel:"Ignore Type",id:"ignoreType",value:!1,margin:10});Ext.getCmp("headerBox").add(ignoreType);var typeSelect=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{id:"typeSelector",margin:10,listeners:{ready:function(){app.typeStore=Ext.getCmp("typeSelector").store,Ext.getCmp("headerBox").insert(2,{xtype:"rallybutton",margin:10,id:"doitButton",text:"Select Item(s)",handler:function(){app._doArtifactChooserDialog(app)}}),app.piStr&&(app._updatePortfolioItemList(app),app._findAllLowestLevelPIs(app))}}});Ext.getCmp("headerBox").insert(0,typeSelect)}});

            Rally.launchApp('CustomApp', {
                name:"WorkItemsForInitiative",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
