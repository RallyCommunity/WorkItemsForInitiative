<!DOCTYPE html>
<html>
<head>
    <title>WorkItemsForInitiative</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.app.WorkItemsForInitiative.app",{extend:"Rally.app.App",componentCls:"app",settingsScope:"app",items:[{xtype:"container",id:"headerBox",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}},{xtype:"container",layout:"hbox",height:500,items:[{xtype:"container",id:"piBurnupBox",border:0,width:"50%",margin:20,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}},{xtype:"container",id:"piBurndownBox",width:"50%",margin:20,border:0,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}}]},{xtype:"container",id:"piDefectBox",border:0,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}},{xtype:"container",id:"piStoryBox",border:0,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}},{xtype:"container",id:"piTaskBox",border:0,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"}}],piStr:"",objStr:[],portfolioIds:null,workItems:[],chsrDlg:null,lowestPiName:"",getSettingsFields:function(){var values=[{name:"epicIDs",xtype:"rallytextfield",hidden:!0},{name:"epicOBJs",xtype:"Ext.Array",hidden:!0}];return _.each(values,function(value){value.labelWidth=250,value.labelAlign="left"}),values},_findAllLowestLevelPIs:function(app){app.typeStore?_.each(app.typeStore.data.items,function(item){0===item.get("Ordinal")&&(app.lowestPiName=item.get("TypePath"))}):Rally.ui.notify.Notifier.show({message:"Portfolio Type Hierarchy not available. Try and reload page"});var piType=Ext.getCmp("typeSelector").rawValue,piStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,storeId:"piStore",fetch:["FormattedID","Name","Children","ScheduleState","PlanEstimate","PlannedStartDate","PlannedEndDate"],hydrate:["FormattedID","Name","ScheduleState","PlannedStartDate","PlannedEndDate"],filters:[{property:"_ItemHierarchy",operator:"$in",value:app.objStr},{property:"_TypeHierarchy",value:app.lowestPiName},{property:"__At",value:"current"}],listeners:{load:function(store,data,success){app.portfolioIds=data,app._updateDetailsPanes(app)}}})},_doArtifactChooserDialog:function(app){app.chsrDlg&&app.chsrDlg.destroy(),artifactType="PortfolioItem",title="Choose ",Ext.getCmp("ignoreType").value===!1&&(artifactType+="/"+Ext.getCmp("typeSelector").rawValue,title+=Ext.getCmp("typeSelector").rawValue),app.chsrDlg=Ext.create("Rally.ui.dialog.SolrArtifactChooserDialog",{artifactTypes:artifactType,autoShow:!0,height:400,title:title+" item(s)",multiple:!0,storeConfig:{fetch:["UserStories","Name","FormattedID","TypePath","ObjectID","PortfolioItemType"],sorters:[{property:"PortfolioItemType",direction:"DESC"},{property:"FormattedID",direction:"ASC"}]},listeners:{artifactchosen:function(dialogBox,selectedRecord){var itmStr="",objStr=[];selectedRecord.forEach(function(record){delim=""===itmStr?"":" ",itmStr+=delim+record.get("FormattedID"),objStr.push(record.get("ObjectID"))}),app.updateSettingsValues({settings:{epicIDs:itmStr,epicOBJs:objStr}}),app.piStr=itmStr,app.objStr=objStr,app._updatePortfolioItemList(app),app._findAllLowestLevelPIs(app)}}})},_piBurnupChart:function(app){Ext.getCmp("piBurnupChart")&&Ext.getCmp("piBurnupChart").destroy();var objList=app.objStr,piBurnupChart=Ext.create("Rally.ui.chart.Chart",{id:"piBurnupChart",calculatorType:"BurnupCalculator",calculatorConfig:{completedScheduleStateNames:["Accepted","Released"],inProgressScheduleStateNames:["In-Progress"],toDoScheduleStateNames:["Triage","Defined"]},storeConfig:{find:{_TypeHierarchy:"HierarchicalRequirement",_ItemHierarchy:{$in:objList},Children:null},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"]},chartColors:[Rally.util.Colors.logo_red,Rally.util.Colors.lime_med,Rally.util.Colors.blue_med,Rally.util.Colors.grey6],chartConfig:{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"PI Burnup"},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:10,title:{text:"Date",margin:10}},yAxis:[{title:{text:"Points"},min:0}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},column:{stacking:"State",shadow:!1}}}});Ext.getCmp("piBurnupBox").add(piBurnupChart),Ext.getCmp("piBurnupBox").setBorder(1)},_getFirstStartDate:function(app){var startDate=new Date;return _.each(app.portfolioIds,function(item){""!==item.data.PlannedStartDate&&Rally.util.DateTime.getDifference(startDate,new Date(item.data.PlannedStartDate),"day")>0&&(startDate=Ext.Date.parse(item.data.PlannedStartDate,"c"))}),startDate},_getLastEndDate:function(app){var endDate=new Date;return _.each(app.portfolioIds,function(item){""!==item.data.PlannedEndDate&&0>Rally.util.DateTime.getDifference(endDate,new Date(item.data.PlannedEndDate),"day")&&(endDate=Ext.Date.parse(item.data.PlannedEndDate,"c"))}),endDate},_piDefectList:function(app){Ext.getCmp("piDefectGrid")&&Ext.getCmp("piDefectGrid").destroy();var objList=app.objStr,piStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,storeId:"piStore",fetch:["FormattedID","Name","ScheduleState","PlanEstimate","State"],hydrate:["FormattedID","Name","ScheduleState","PlanEstimate","State"],filters:[{property:"_ItemHierarchy",operator:"$in",value:app.objStr},{property:"_TypeHierarchy",value:"Defect"},{property:"__At",value:"current"}],listeners:{load:function(store,data,success){_.each(data,function(record){record.set("_ref","/defect/"+record.get("ObjectID")),record.set("_type","defect")});var defectGrid=Ext.create("Rally.ui.grid.Grid",{title:"Defects connected to stories for selected items",id:"piDefectGrid",enableColumnMove:!0,enableColumnResize:!0,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),width:50},{text:"Name",dataIndex:"Name",flex:1},{text:"State",dataIndex:"State"},{text:" Schedule State",dataIndex:"ScheduleState",renderer:function(value){return value}}],sortableColumns:!0,store:store});Ext.getCmp("piDefectBox").add(defectGrid),Ext.getCmp("piDefectBox").setBorder(1),Ext.getCmp("piDefectBox").setMargin(10)}}})},_piUserList:function(app){Ext.getCmp("piUserStoryGrid")&&Ext.getCmp("piUserStoryGrid").destroy();var objList=app.objStr,piStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,storeId:"piStore",fetch:["FormattedID","Name","ScheduleState","PlanEstimate"],hydrate:["FormattedID","Name","ScheduleState","PlanEstimate"],filters:[{property:"_ItemHierarchy",operator:"$in",value:app.objStr},{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"__At",value:"current"}],listeners:{load:function(store,data,success){_.each(data,function(record){record.set("_ref","/hierarchicalrequirement/"+record.get("ObjectID")),record.set("_type","userstory")});var storyGrid=Ext.create("Rally.ui.grid.Grid",{title:"Stories for selected items",id:"piUserStoryGrid",enableColumnMove:!0,enableColumnResize:!0,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),width:50},{text:"Name",dataIndex:"Name",flex:1},{text:" Schedule State",dataIndex:"ScheduleState",renderer:function(value){return value}}],sortableColumns:!0,store:store});Ext.getCmp("piStoryBox").add(storyGrid),Ext.getCmp("piStoryBox").setMargin(10),Ext.getCmp("piStoryBox").setBorder(1)}}})},_piBLockersList:function(app){Ext.getCmp("piBlockerGrid")&&Ext.getCmp("piBlockerGrid").destroy();var objList=app.objStr,piStore=Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,storeId:"piStore",fetch:["FormattedID","Name","Blocked","BlockedReason","ToDo"],hydrate:["FormattedID","Name","Blocked","BlockedReason","ToDo"],filters:[{property:"_ItemHierarchy",operator:"$in",value:app.objStr},{property:"_TypeHierarchy",value:"Task"},{property:"Blocked",value:!0},{property:"__At",value:"current"}],listeners:{load:function(store,data,success){_.each(data,function(record){record.set("_ref","/task/"+record.get("ObjectID")),record.set("_type","task")});var storyGrid=Ext.create("Rally.ui.grid.Grid",{title:"Blocked Tasks",id:"piTaskGrid",enableColumnMove:!0,enableColumnResize:!0,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),width:50},{text:"Name",dataIndex:"Name",flex:1},{text:"Blocked Reason",dataIndex:"BlockedReason"},{text:"To Do",dataIndex:"ToDo"}],sortableColumns:!0,store:store});Ext.getCmp("piTaskBox").add(storyGrid),Ext.getCmp("piTaskBox").setMargin(10),Ext.getCmp("piTaskBox").setBorder(1)}}})},_piBurndownChart:function(app){Ext.getCmp("piBurndownChart")&&Ext.getCmp("piBurndownChart").destroy();var objList=app.objStr;1!==app.piStr.split(" ").length&&Rally.ui.notify.Notifier.show({message:"Re-select a single item to get a meaningful Burndown Chart"});var burndownchart=Ext.create("Rally.ui.chart.Chart",{id:"piBurndownchart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{_TypeHierarchy:"HierarchicalRequirement",_ItemHierarchy:{$in:objList},Children:null},fetch:["ScheduleState","PlanEstimate","ObjectId","_ValidFrom","_ValidTo","To Do"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},compress:!0,useHttpPost:!0},calculatorType:"BurndownCalculator",calculatorConfig:{timeZone:"GMT",completedScheduleStateNames:["Accepted","Released"],enableProjections:!0,startDate:app._getFirstStartDate(app),endDate:app._getLastEndDate(app)},chartColors:[Rally.util.Colors.logo_red,Rally.util.Colors.blue_med,Rally.util.Colors.lime_med,Rally.util.Colors.grey6],chartConfig:{chart:{zoomType:"xy"},title:{text:"PI Burndown (Planned Estimate)"},xAxis:{categories:[],tickmarkPlacement:"on",tickInterval:14,title:{text:"Days",margin:12},maxPadding:.25,labels:{x:0,y:20,overflow:"justify"}},yAxis:[{title:{text:"Points"},min:0}],tooltip:{formatter:function(){var floatValue=parseFloat(this.y),value=this.y;return isNaN(floatValue)||(value=Math.floor(100*floatValue)/100),""+this.x+"<br />"+this.series.name+": "+value}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},connectNulls:!0},column:{pointPadding:0,borderWidth:0,stacking:null,shadow:!1}}}});Ext.getCmp("piBurndownBox").add(burndownchart),Ext.getCmp("piBurndownBox").setBorder(1)},_updateDetailsPanes:function(app){app._piBurnupChart(app),app._piBurndownChart(app),app._piDefectList(app),app._piUserList(app),app._piBLockersList(app)},_updatePortfolioItemList:function(app){Ext.getCmp("selectionFromSettings")&&Ext.getCmp("selectionFromSettings").destroy();var txtMsg=Ext.create("Ext.form.field.Text",{fieldLabel:"Current Selected",id:"selectionFromSettings",grow:!0,value:app.piStr,border:0,margin:10,readOnly:!0});Ext.getCmp("headerBox").add(txtMsg)},typeStore:null,launch:function(){var app=this;ids=app.getSetting("epicIDs"),objs=app.getSetting("epicOBJs"),ids&&objs&&(app.piStr=ids,app.objStr=objs);var ignoreType=Ext.create("Rally.ui.CheckboxField",{fieldLabel:"Ignore Type",id:"ignoreType",value:!1,margin:10});Ext.getCmp("headerBox").add(ignoreType);var typeSelect=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{id:"typeSelector",margin:10,listeners:{ready:function(){app.typeStore=Ext.getCmp("typeSelector").store,Ext.getCmp("headerBox").insert(2,{xtype:"rallybutton",margin:10,id:"doitButton",text:"Select Item(s)",handler:function(){app._doArtifactChooserDialog(app)}})}}});Ext.getCmp("headerBox").insert(0,typeSelect)}});
                Ext.define("DateMixin",{dateFormatters:[{key:"MMM",value:"%b"},{key:"MM",value:"%m"},{key:"dd",value:"%d"},{key:"yyyy",value:"%Y"}],dateToStringDisplay:function(date){return Ext.Date.format(date,"m/d/Y")},dateToString:function(date){return Ext.Date.format(date,"Y-m-d\\TH:i:s.u\\Z")},dateStringToObject:function(dateStr){var finalIndex=dateStr.indexOf("T"),dateObj;return finalIndex>-1&&(dateStr=dateStr.slice(0,dateStr.indexOf("T"))),dateObj=this._splitDateParts(dateStr),new Date(dateObj.year,dateObj.month,dateObj.day)},_splitDateParts:function(dateStr){return this._shouldSplitOnDash(dateStr)?this._objectFromYearFirstDate(dateStr.split("-")):this._objectFromMonthFirstDate(dateStr.split("/"))},_objectFromYearFirstDate:function(dateArray){return 3!==dateArray.length?{year:0,month:0,day:0}:(dateArray[1]=""+(parseInt(dateArray[1],10)-1),{year:dateArray[0],month:dateArray[1],day:dateArray[2]})},_objectFromMonthFirstDate:function(dateArray){return 3!==dateArray.length?{year:0,month:0,day:0}:(dateArray[0]=""+(parseInt(dateArray[0],10)-1),{month:dateArray[0],day:dateArray[1],year:dateArray[2]})},_shouldSplitOnDash:function(dateStr){return 3===dateStr.split("-").length}});
                Ext.define("BurnupCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{completedScheduleStateNames:["Accepted"],inProgressScheduleStateNames:["In Progress"],toDoScheduleStateNames:["Backlog","Defined"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getDerivedFieldsOnInput:function(){var completedScheduleStateNames=this.getCompletedScheduleStateNames(),inProgressScheduleStateNames=this.config.inProgressScheduleStateNames,toDoScheduleStateNames=this.config.toDoScheduleStateNames;return[{as:"Planned",f:function(snapshot){return snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"PlannedCompleted",f:function(snapshot){return _.contains(completedScheduleStateNames,snapshot.ScheduleState)&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"PlannedInProgress",f:function(snapshot){return _.contains(inProgressScheduleStateNames,snapshot.ScheduleState)&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}},{as:"PlannedToDo",f:function(snapshot){return _.contains(toDoScheduleStateNames,snapshot.ScheduleState)&&snapshot.PlanEstimate?snapshot.PlanEstimate:0}}]},getMetrics:function(){return[{field:"PlannedToDo",as:"To Do",f:"sum",display:"column"},{field:"PlannedInProgress",as:"In-progress",f:"sum",display:"column"},{field:"PlannedCompleted",as:"Completed",f:"sum",display:"column"},{field:"Planned",as:"Planned",display:"line",f:"sum"}]}});
                Ext.define("BurndownCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["DateMixin"],getDerivedFieldsOnInput:function(){var completedStates=this.config.completedScheduleStateNames,aggregationType=this.config.chartAggregationType;return[{as:"RemainingPoints",f:function(snapshot){var ss=snapshot.ScheduleState;if(0>completedStates.indexOf(ss)){if("storycount"===aggregationType)return 1;if(snapshot.PlanEstimate)return snapshot.PlanEstimate}return 0}},{as:"AcceptedPoints",f:function(snapshot){var ss=snapshot.ScheduleState;if(completedStates.indexOf(ss)>-1){if("storycount"===aggregationType)return 1;if(snapshot.PlanEstimate)return snapshot.PlanEstimate}return 0}}]},getMetrics:function(){return[{field:"RemainingPoints",as:"To Do",f:"sum"},{field:"AcceptedPoints",as:"Accepted",f:"sum"}]},getSummaryMetricsConfig:function(){return[{as:"Scope_max",f:function(seriesData){var max=0,i=0;for(i=0;seriesData.length>i;i++)seriesData[i].Accepted+seriesData[i]["To Do"]>max&&(max=seriesData[i].Accepted+seriesData[i]["To Do"]);return max}}]},getDerivedFieldsAfterSummary:function(){return[{as:"Ideal",f:function(row,index,summaryMetrics,seriesData){var max=summaryMetrics.Scope_max,increments=seriesData.length-1,incrementAmount;return 0===increments?max:(incrementAmount=max/increments,Math.floor(100*(max-index*incrementAmount))/100)},display:"line"},{as:"Prediction",f:function(row,index,summaryMetrics,seriesData){return null},display:"line",dashStyle:"Dash"}]},getProjectionsConfig:function(){var days=(Rally.util.DateTime.fromIsoString(this.config.endDate).getTime()-Rally.util.DateTime.fromIsoString(this.config.startDate).getTime())/864e5,doubleTimeboxEnd=Ext.Date.add(Rally.util.DateTime.fromIsoString(this.config.startDate),Ext.Date.DAY,2*Math.floor(days)-1),timeboxEnd=Ext.Date.add(Rally.util.DateTime.fromIsoString(this.config.endDate),Ext.Date.DAY,-1);return void 0===this.projectionsConfig&&(this.projectionsConfig={doubleTimeboxEnd:doubleTimeboxEnd,timeboxEnd:timeboxEnd,series:[{as:"Prediction",field:"To Do"}],continueWhile:function(point){var dt=Rally.util.DateTime.fromIsoString(point.tick),end=this.series[0].slope>=0?this.timeboxEnd:this.doubleTimeboxEnd;return point.Prediction>0&&end>dt}}),this.projectionsConfig},_firstNonZero:function(data){var i;for(i=0;data.length>i;i++)if(data[i]>0)return i;return 0},_leastSquares:function(todoValues,firstIndex,lastIndex){var n=lastIndex+1-firstIndex,i,sumx=0,sumx2=0,sumy=0,sumy2=0,sumxy=0,slope,yintercept;for(i=firstIndex;lastIndex>=i;i++)sumx+=i,sumx2+=i*i,sumy+=todoValues[i],sumy2+=todoValues[i]*todoValues[i],sumxy+=i*todoValues[i];return slope=(n*sumxy-sumx*sumy)/(n*sumx2-sumx*sumx),yintercept=(sumy*sumx2-sumx*sumxy)/(n*sumx2-sumx*sumx),{slope:slope,yintercept:yintercept}},runCalculation:function(snapshots){var chartData=this.callParent(arguments);if(chartData&&chartData.projections&&chartData.projections.series[0].slope>0){var todoData=chartData.series[0].data,firstTodoIndex=this._firstNonZero(todoData),lastTodoIndex=todoData.length-1-chartData.projections.pointsAddedCount,results=this._leastSquares(todoData,firstTodoIndex,lastTodoIndex);if(0>=results.slope)this.projectionsConfig.series[0].slope=results.slope,chartData=this.callParent(arguments),chartData.series[3].data[firstTodoIndex]=results.slope*firstTodoIndex+results.yintercept+(chartData.series[3].data[lastTodoIndex]-(results.slope*lastTodoIndex+results.yintercept)),chartData.series[3].connectNulls=!0,this.projectionsConfig=void 0;else{var predictionCeiling=1.25*chartData.series[2].data[0];if(_.max(chartData.series[3].data)>predictionCeiling){var i,maxVal=predictionCeiling;for(i=0;chartData.series[3].data.length>i;i++)chartData.series[3].data[i]>predictionCeiling&&(chartData.series[3].data[i]=maxVal,maxVal=null)}}}return new Date<this.config.endDate&&this._recomputeIdeal(chartData,this.config.endDate),chartData},_recomputeIdeal:function(chartData,endDate){var index;if(!(1>chartData.categories.length||1>this.workDays.length)){var lastDate=Ext.Date.parse(chartData.categories[chartData.categories.length-1],"Y-m-d");if(endDate>lastDate){index=chartData.categories.length;for(var dt=Ext.Date.add(lastDate,Ext.Date.DAY,1);endDate>dt;){for(;-1===this.workDays.indexOf(Ext.Date.format(dt,"l"));)dt=Ext.Date.add(dt,Ext.Date.DAY,1);endDate>dt&&(chartData.categories[index++]=Ext.Date.format(dt,"Y-m-d")),dt=Ext.Date.add(dt,Ext.Date.DAY,1)}index=chartData.categories.length-1}else if(index=this._indexOfDate(chartData,endDate),-1===index)for(;-1===this.workDays.indexOf(Ext.Date.format(endDate,"l"));)endDate=Ext.Date.add(endDate,Ext.Date.DAY,-1),index=this._indexOfDate(chartData,endDate);if(!(0>index)){var i,seriesData=chartData.series[2].data;for(i=1;index>i;i++)seriesData[i]=null;seriesData[index]=0}}},_indexOfDate:function(chartData,date){var dateStr=Ext.Date.format(date,"Y-m-d");return chartData.categories.indexOf(dateStr)},_removeFutureSeries:function(chartData,seriesIndex,dayIndex){if(chartData.series[seriesIndex].data.length>dayIndex)for(;++dayIndex<chartData.series[seriesIndex].data.length;)chartData.series[seriesIndex].data[dayIndex]=null},_projectionsSlopePositive:function(chartData){return chartData.projections&&chartData.projections.series?chartData.projections.series[0].slope>=0:!0}});

            Rally.launchApp('Rally.app.WorkItemsForInitiative.app', {
                name:"WorkItemsForInitiative",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
